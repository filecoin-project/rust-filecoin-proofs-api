version: 2.1

executors:
  linux:
    docker:
      - image: cimg/rust:1.67
    resource_class: small

jobs:
  test:
    executor: linux
    environment:
      RUST_LOG: trace
    steps:
      - checkout
      - run:
          name: Install requirements
          command: |
            sudo apt update
            sudo apt install ocl-icd-opencl-dev --yes
      - run:
          name: Test
          command: cargo test --verbose

  rustfmt:
    executor: linux
    steps:
      - checkout
      - run:
          name: Run cargo fmt
          command: cargo fmt --all -- --check

  clippy:
    executor: linux
    steps:
      - checkout
      - run:
          name: Run cargo clippy
          command: cargo clippy --workspace -- -D warnings

  test_darwin:
    macos:
      xcode: "13.4.1"
    resource_class: medium
    environment:
      RUST_LOG: trace
    steps:
      - checkout
      - run:
          name: Install other dependencies with Homebrew
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install hwloc rustup-init
      - run:
          name: Install Rust
          command: |
            rustup-init --profile minimal --default-toolchain $(cat rust-toolchain) -y
            source ${HOME}/.cargo/env
      - run:
          name: Test (Darwin)
          command: cargo test --release --verbose

workflows:
  version: 2.1
  test_all:
    jobs:
      - rustfmt
      - clippy
      - test
      - test_darwin
